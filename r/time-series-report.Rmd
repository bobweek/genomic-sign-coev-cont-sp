---
title: "host-parasite coevolution summary"
output:
  rmdformats::downcute:
    self_contained: true
    highlight: tango
    downcute_theme: "chaos"
    default_style: "light"
    toc_float: false
editor_options: 
  chunk_output_type: console
---

## a few stats

clearly, the first two should be equal. but printing just as sanity check for now.

```{r echo=F, message=FALSE, warning=FALSE,results='asis'}
require(ggplot2)
# require(ggdark)

# pool all ild scores together in matrix
# grab indices for top 99th percentile
# compute the fraction of ild scores in top 99th percentile
# that correspond to causal pairs
# that correspond to one causal locus and one neutral locus

hsnps = as.matrix(read.csv("~/gsccs-data/h-csl-snps.csv",header=F)+1)
psnps = as.matrix(read.csv("~/gsccs-data/p-csl-snps.csv",header=F)+1)

ild.cor = as.matrix(read.csv("~/gsccs-data/ild-cor.csv", header=F))
ild.cov = as.matrix(read.csv("~/gsccs-data/ild-cov.csv", header=F))

topttl = function(ild){
  qtl = quantile(ild,0.99)
  topinds = which(ild>qtl, arr.ind = T)
  topttl = length(topinds[,1])
  return(topttl)
}

summStats = function(ild){
  qtl = quantile(ild,0.99)
  topinds = which(ild>qtl, arr.ind = T)
  
  hcslinds = topinds[,1] <= length(hsnps)
  pcslinds = topinds[,2] <= length(psnps)

  cslprs = hcslinds & pcslinds
  cslsgl = (hcslinds & !pcslinds) | (!hcslinds & pcslinds)
  
  topttl = length(topinds[,1])
  prfrac = sum(cslprs)/topttl
  sgfrac = sum(cslsgl)/topttl
  cbfrac = prfrac+sgfrac
  
  hprrep = topinds[cslprs,1]
  pprrep = topinds[cslprs,2]
  
  hprcpt = unique(hprrep)
  pprcpt = unique(pprrep)
  
  hcslfrac = length(hprcpt)/length(hsnps)
  pcslfrac = length(pprcpt)/length(psnps)
  
  hsgrep = topinds[hcslinds,1]
  psgrep = topinds[pcslinds,2]
  
  hsgcpt = unique(hsgrep)
  psgcpt = unique(psgrep)
  
  hsglfrac = length(hsgcpt)/length(hsnps)
  psglfrac = length(psgcpt)/length(psnps)
  
  hild99cslspec = c()
  for(i in hsgcpt){
    hild99cslspec = c(hild99cslspec, sum(hsgrep==i))
  }
  pild99cslspec = c()
  for(i in psgcpt){
    pild99cslspec = c(pild99cslspec, sum(psgrep==i))
  }
  
  hcsl99fd = c()
  for(i in 1:max(hild99cslspec)){
    hcsl99fd = c(hcsl99fd, sum(hild99cslspec==i))
  }
  pcsl99fd = c()
  for(i in 1:max(pild99cslspec)){
    pcsl99fd = c(pcsl99fd, sum(pild99cslspec==i))
  }
  
  hntlrep = topinds[!hcslinds,1]
  pntlrep = topinds[!pcslinds,2]
  
  hntlcpt = unique(hntlrep)
  pntlcpt = unique(pntlrep)
  
  hild99ntlspec = c()
  for(i in hntlcpt){
    hild99ntlspec = c(hild99ntlspec, sum(hntlrep==i))
  }
  pild99ntlspec = c()
  for(i in pntlcpt){
    pild99ntlspec = c(pild99ntlspec, sum(pntlrep==i))
  }
  
  hntl99fd = rep(0,max(hild99cslspec))
  for(i in 1:max(hild99cslspec)){
    hntl99fd[i] = sum(hild99ntlspec==i)
  }
  pntl99fd = rep(0,max(pild99cslspec))
  for(i in 1:max(pild99cslspec)){
    pntl99fd[i] = sum(pild99ntlspec==i)
  }
  
  spps = rep(c(rep("Host",max(hild99cslspec)),rep("Parasite",max(pild99cslspec))),2)
  hcsls = rep("csl",length(hcsl99fd))
  hntls = rep("ntl",length(hntl99fd))
  pcsls = rep("csl",length(pcsl99fd))
  pntls = rep("ntl",length(pntl99fd))
  fddf = data.frame(f=c(1:max(hild99cslspec),1:max(pild99cslspec)),
                    c=c(hcsl99fd,pcsl99fd,hntl99fd,pntl99fd),
                    type=c(hcsls,pcsls,hntls,pntls),
                    spp=spps)
  
  stts = data.frame(prfrac,sgfrac,cbfrac,hcslfrac,pcslfrac,hsglfrac,psglfrac)

  return(list(fddf,stts))
  
}

ss.cor = summStats(ild.cor)
ss.cov = summStats(ild.cov)

fddf.cor = ss.cor[[1]]
fddf.cov = ss.cov[[1]]

bsd = c(rep("cor",length(fddf.cor$f)),
        rep("cov",length(fddf.cov$f)))

fddf = data.frame(rbind(fddf.cor,fddf.cov),base=bsd)

frc.cor = ss.cor[[2]]
frc.cov = ss.cov[[2]]

# \/ perhaps do this in python using genotype arrays \/
# for each spp, identify set of causal loci that explain
# 95% of phenotypic variation in the population
# refer to these as "truly causal loci"
# then, compute fraction of these causal loci that occur in
# the 99th percentile of ild scores for
# just the causal pairs
# just the causal "singletons" (ie, one causal one neutral)

descrs = c("Number cor-based ild pairs occuring in top 99th percentile",
           "Number cov-based ild pairs occuring in top 99th percentile",
           "Number host causal loci",
           "Number para causal loci")
vals = c(topttl(ild.cor),topttl(ild.cov),length(hsnps),length(psnps))
statdt = cbind(descrs,formatC(as.numeric(vals))) #, digits = 1, format = "e", drop0trailing = FALSE))
statdf = data.frame(statdt)
colnames(statdf) = c("Description","Value")
knitr::kable(statdf)

```

## performance measures

"Fraction of top 99th perc corresponding to _X_" is a fraction of interspecific pairs of loci that appear in the 99th percentile of ild scores corresponding to property _X_.

```{r echo=F, message=FALSE, warning=FALSE,results='asis'}
# make table of performance measures
descrs = c("Fraction of top 99th perc corresponding to a causal pair",
           "Fraction of top 99th perc corresponding to exactly one causal locus",
           "Fraction of top 99th perc corresponding to at least one causal locus",
           "Fraction host loci appearing in causal pair in the 99th perc",
           "Fraction para loci appearing in causal pair in the 99th perc",
           "Fraction host loci appearing in any pair in the 99th perc",
           "Fraction para loci appearing in any pair in the 99th perc")
cor.vals = c(frc.cor$prfrac,frc.cor$sgfrac,frc.cor$cbfrac,
             frc.cor$hcslfrac,frc.cor$pcslfrac,frc.cor$hsglfrac,frc.cor$psglfrac)
cov.vals = c(frc.cov$prfrac,frc.cov$sgfrac,frc.cov$cbfrac,
             frc.cov$hcslfrac,frc.cov$pcslfrac,frc.cov$hsglfrac,frc.cov$psglfrac)
pfmsrdt = cbind(descrs,formatC(as.numeric(cor.vals)),formatC(as.numeric(cov.vals))) #, digits = 1, format = "e", drop0trailing = FALSE))
pfmsr = data.frame(pfmsrdt)
colnames(pfmsr) = c("Description","Cor","Cov")
knitr::kable(pfmsr)
```

Frequencies that causal and neutral loci appear in 99th perc of ild scores. Sort of like sfs, but number of loci that occur a given number of times in 99th perc instead of number loci that occur at a given freq in a population.

```{r echo=F, message=FALSE, warning=FALSE,results='asis'}
ggplot(fddf,aes(x=f,y=c,fill=type)) +
  geom_bar(stat="identity", position=position_dodge()) +
  facet_grid(spp~base) +
  ylab("Count")+xlab("99th perc occurance")+
  scale_fill_manual("legend", values = c("csl" = "magenta", "ntl" = "turquoise1")) +
  theme_minimal()
```

## ild score vs effect size and/or genetic variance

<!-- the reason why p(1-p) correlates so strongly is cause its var. try rescaling... -->

```{r echo=F, message=FALSE, warning=FALSE,results='asis'}
colors <- c("Parasite" = "purple", "Host" = "orange")

# insert plots of ild x effect size for both spp
# where each effect size is associated with all ild at that locus
# check if effect size correlates with max(ild)

# might want to multiply effect size by genetic variance

# for a trait Z=a*I, I~Bern(p) and a in R, Var(Z)=a^2*p(1-p)
# so, for L unlinked loci, Var(Z)=sum_i(a[i]^2*p[i]*(1-p[i]))
# and the prop of var explained by locus l is
# a[l]^2*p[l]*(1-p[l])/Var(Z)
# ignored not only ld, but also homozygosity

hes = as.matrix(read.csv("~/gsccs-data/h-effect-sizes.csv", header=F))
pes = as.matrix(read.csv("~/gsccs-data/p-effect-sizes.csv", header=F))
hfq = as.matrix(read.csv("~/gsccs-data/hfrq-csl-gbl.csv", header = F))
pfq = as.matrix(read.csv("~/gsccs-data/pfrq-csl-gbl.csv", header = F))

hvrsk = hes^2*hfq*(1-hfq)
pvrsk = pes^2*pfq*(1-pfq)

hmaxild.cor = rep(0,length(hes))
for(i in 1:length(hes)){
  hmaxild.cor[i] = max(abs(ild.cor[i,]))
}
pmaxild.cor = rep(0,length(pes))
for(i in 1:length(pes)){
  pmaxild.cor[i] = max(abs(ild.cor[,i]))
}

hmaxild.cov = rep(0,length(hes))
for(i in 1:length(hes)){
  hmaxild.cov[i] = max(abs(ild.cov[i,]))
}
pmaxild.cov = rep(0,length(pes))
for(i in 1:length(pes)){
  pmaxild.cov[i] = max(abs(ild.cov[,i]))
}

lgth = length(c(hes^2,pes^2))
skild = data.frame(sk=abs(c(hvrsk,pvrsk,hvrsk,pvrsk)), 
           ild=c(hmaxild.cor,pmaxild.cor,hmaxild.cov,pmaxild.cov),
           es2=c(hes^2,pes^2,hes^2,pes^2),
           gv=c(hfq*(1-hfq),pfq*(1-pfq),hfq*(1-hfq),pfq*(1-pfq)), 
           spp=rep(c(rep("Host",length(hes)),rep("Parasite",length(pes))),2),
           base=c(rep("cor",lgth),rep("cov",lgth)))

ggplot(skild) + 
  geom_point(aes(x=sk,y=ild, color=spp)) +
  labs(x = "pᵢ(1-pᵢ)(Effect Size)ᵢ²",        
       y = "max(ILD)ᵢ",        
       color = "Legend") +
  scale_color_manual(values = colors) +
  facet_wrap(~base,scale="free_y") +
  theme_minimal()

ggplot(skild) + 
  geom_point(aes(x=gv,y=ild, color=spp)) +
  labs(x = "pᵢ(1-pᵢ)",        
       y = "max(ILD)ᵢ",        
       color = "Legend") +
  scale_color_manual(values = colors) +
  facet_wrap(~base,scale="free_y") +
  theme_minimal()

ggplot(skild) + 
  geom_point(aes(x=es2,y=ild, color=spp)) +
  labs(x = "(Effect Size)ᵢ²",        
       y = "max(ILD)ᵢ",        
       color = "Legend") +
  scale_color_manual(values = colors) +
  facet_wrap(~base,scale="free_y") +
  theme_minimal()

# ntl_ild_cor = read.csv("~/gsccs-data/ntl-ild-cor-flat.csv", header = F)
# ntl_ild_cov = read.csv("~/gsccs-data/ntl-ild-cov-flat.csv", header = F)
# csl_ild_cor = read.csv("~/gsccs-data/csl-ild-cor-flat.csv", header = F)
# csl_ild_cov = read.csv("~/gsccs-data/csl-ild-cov-flat.csv", header = F)
# 
# kprs = list(ntlcor=1,ntlcov=2,cslcor=3,cslcov=4)
# dfs = list(ntlcor=ntl_ild_cor,ntlcov=ntl_ild_cov,cslcor=csl_ild_cor,cslcov=csl_ild_cov)
# 
# for(i in 1:2){
#   dfs[[i]]$V1 = abs(dfs[[i]]$V1)
#   qtl = quantile(dfs[[i]]$V1,0.99)
#   kprs[[i]] = which(dfs[[i]]$V1>qtl)
# }
# for(i in 3:4){
#   dfs[[i]]$V1 = abs(dfs[[i]]$V1)
#   qtl = quantile(dfs[[i-2]]$V1,0.99)
#   kprs[[i]] = which(dfs[[i]]$V1>qtl)
# }
# 
# lumpnms = c(rep("ntl",length(kprs$ntlcor)),rep("csl",length(kprs$cslcor)))
# lumpcrs = c(dfs$ntlcor$V1[kprs$ntlcor],dfs$cslcor$V1[kprs$cslcor])
# cor_df = data.frame(lumpcrs,lumpnms)
# colnames(cor_df) = c("ild","set")
# 
# lumpnms = c(rep("ntl",length(kprs$ntlcov)),rep("csl",length(kprs$cslcov)))
# lumpcvs = c(dfs$ntlcov$V1[kprs$ntlcov],dfs$cslcov$V1[kprs$cslcov])
# cov_df = data.frame(lumpcvs,lumpnms)
# colnames(cov_df) = c("ild","set")
# 
# ggplot(cor_df) +
#   geom_histogram(aes(x=ild,y=..density..,fill=set),
#                  bins=50,alpha=0.25,position = "identity") +
#   xlab("99th Perc Spatial Correlations") +
#   ylab("Density") +
#   theme_minimal()
# 
# ggplot(cov_df) +
#   geom_histogram(aes(x=ild,y=..density..,fill=set),
#                  bins=50,alpha=0.25,position = "identity") +
#   xlab("99th Perc Spatial Covariances") +
#   ylab("Density") +
#   theme_minimal()
```

## ild cor-vs-cov

```{r echo=F, message=FALSE, warning=FALSE,results='asis'}
# scatter plot of cov vs cor ild values

crvscv = data.frame(cor=as.vector(ild.cor),cov=as.vector(ild.cov))
ggplot(crvscv,aes(x=cor,y=cov)) + 
  geom_point(color='black',alpha=0.25) +
  xlab("Correlation-based ILD") +
  ylab("Covariance-based ILD") +
  theme_minimal()

```


## time-series

```{r echo=F, message=FALSE, warning=FALSE,results='asis'}
params = read.csv("~/gsccs-data/params.csv")
tsdf = read.csv("~/gsccs-data/time-series.csv")

ggplot(tsdf) + 
  geom_line(aes(x=t,y=Nh,color="Host")) +
  geom_line(aes(x=t,y=Np,color="Parasite")) +
  labs(x = "Time",        
       y = "Global Census Size",        
       color = "Legend") +   
  scale_color_manual(values = colors) +
  theme_minimal()

ggplot(tsdf) + 
  geom_line(aes(x=t,y=zh,color="Host")) +
  geom_line(aes(x=t,y=zp,color="Parasite")) +
  labs(x = "Time",        
       y = "Global Trait Means",        
       color = "Legend") +   
  scale_color_manual(values = colors) +
  theme_minimal()

ggplot(tsdf) + 
  geom_line(aes(x=t,y=pntcorr)) +
  labs(x = "Time",        
       y = "Spatial Correlation of Traits",        
       color = "Legend") +   
  scale_color_manual(values = colors) +
  ylim(c(-1,1)) +
  theme_minimal()

ggplot(tsdf) + 
  geom_line(aes(x=t,y=vh,color="Host")) +
  geom_line(aes(x=t,y=vp,color="Parasite")) +
  labs(x = "Time",        
       y = "Global Trait Stddevs",        
       color = "Legend") +   
  scale_color_manual(values = colors) +
  theme_minimal()

frqs = read.csv("~/gsccs-data/mut-freqs.csv")

frqs$frq[frqs$frq==0] = NA

hfq.df = subset(frqs,spp==1)
pfq.df = subset(frqs,spp==2)

ggplot(hfq.df,aes(x=t,y=frq)) + 
  geom_line(aes(color=as.character(id)),alpha=0.5,lwd=.2) + 
  xlab("Time") +
  ylab("Host Mutation Freqs") +
  theme_minimal() +
  theme(legend.position="none")

ggplot(pfq.df,aes(x=t,y=frq)) + 
  geom_line(aes(color=as.character(id)),alpha=0.5,lwd=0.2) + 
  xlab("Time") +
  ylab("Para Mutation Freqs") +
  theme_minimal() +
  theme(legend.position="none")

ggplot(tsdf) + 
  geom_line(aes(x=t,y=muh,color="Host")) +
  geom_line(aes(x=t,y=mup,color="Parasite")) +
  labs(x = "Time",
       y = "Num Polymorphic Loci",
       color = "Legend") +   
  scale_color_manual(values = colors) +
  theme_minimal()

ggplot(tsdf) + 
  geom_line(aes(x=t,y=abar)) +
  labs(x = "Time",
       y = "Average Infection Probability",        
       color = "Legend") +   
  ylim(c(0,1))+
  scale_color_manual(values = colors) +
  theme_minimal()

# ggplot(tsdf) + 
#   geom_line(aes(x=t,y=vara)) +
#   labs(x = "Time",        
#        y = "Variance of Infection Probability",
#        color = "Legend") +   
#   scale_color_manual(values = colors) +
#   theme_minimal()

ggplot(tsdf) + 
  geom_line(aes(x=t,y=hselresp)) +
  labs(x = "Time",        
       y = "Host Response to Biotic Selection",        
       color = "Legend") +   
  scale_color_manual(values = colors) +
  theme_minimal()

ggplot(tsdf) + 
  geom_line(aes(x=t,y=pselresp)) +
  labs(x = "Time",        
       y = "Parasite Response to Biotic Selection",
       color = "Legend") +   
  scale_color_manual(values = colors) +
  theme_minimal()

ggplot(tsdf) + 
  geom_line(aes(x=t,y=(1-pr_unparasitized),color="Host")) +
  geom_line(aes(x=t,y=(1-pr_unhosted),color="Parasite")) +
  labs(x = "Time",        
       y = "Proportion Interaction Attempted",        
       color = "Legend") +   
  scale_color_manual(values = colors) +
  ylim(c(0,1)) +
  theme_minimal()
```

## parameter values

```{r echo=F, message=FALSE, warning=FALSE,results='asis'}
descrs = c("host mutation rate","parasite mutation rate","host mutation effect size","parasite mutation effect size",
           "host dispersal distance","parasite dispersal distance","host-parasite interaction dist","host competition",
           "parasite competition","host competition dist","parasite competition dist","host base fitness","parasite base fitness",
           "host biotic selection","parasite biotic selection","infection probability sensitivity","host initial density",
           "parasite initial density","temporal resolution of time-series")
txtdat = cbind(colnames(params),descrs,formatC(as.numeric(params), digits = 1, format = "e", drop0trailing = FALSE))
txtdf = data.frame(txtdat)
colnames(txtdf) = c("Param","Description","Value")

knitr::kable(txtdf)
```
